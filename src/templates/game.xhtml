<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html 
      PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" 
      xmlns:svg="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"> 
<head>
<link type="text/css" rel="stylesheet" href="/static/game.css"></link>
<link type="text/css" rel="stylesheet" href="/static/reset.css" />
<link type="text/css" rel="stylesheet" href="/static/picture.css" />
<!-- <script type="text/javascript" src="/static/json.js"></script> -->
<!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js" type="text/javascript"></script> -->
<script type="text/javascript" src="/static/lib/jquery-1.6.min.js"></script> 
<script type="text/javascript" src="/static/lib/jquery-ext.js"></script>
<script type="text/javascript" src="/_ah/channel/jsapi"></script>
<script type="text/javascript" src="/static/lib/event.js"></script>
<script type="text/javascript" src="/static/lib/transform2d.js"></script>
<script type="text/javascript" src="/static/model/player.js"></script>
<script type="text/javascript" src="/static/model/board.js"></script>
<script type="text/javascript" src="/static/model/trade.js"></script>
<script type="text/javascript" src="/static/view/boardView.js"></script>
<script type="text/javascript" src="/static/view/actionsView.js"></script>
<script type="text/javascript" src="/static/view/diceView.js"></script>
<script type="text/javascript" src="/static/view/playerListView.js"></script>
<script type="text/javascript" src="/static/view/errorView.js"></script>
<script type="text/javascript" src="/static/view/playerView.js"></script>
<script type="text/javascript" src="/static/view/layout.js"></script>
<script type="text/javascript" src="/static/view/resourcesView.js"></script>
<script type="text/javascript" src="/static/view/tradeView.js"></script>
<script type="text/javascript" src="/static/view/dashboardView.js"></script>
<script type="text/javascript" src="/static/chat.js"></script>
<script type="text/javascript">//<![CDATA[

function getCookie(name) {
    var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
    return r ? r[1] : undefined;
}



function handleLoad() {
	var board = new Board("{{token}}", {
		"board-json-url": "{{boardUrl}}",
		"player-json-url": "{{playerUrl}}",
		"action-json-url": "{{actionUrl}}",
		"reservation-json-url": "{{reservationUrl}}",
		"trade-json-url":"{{tradeUrl}}"
	});
	
	var layout = new Layout();
	
	var boardView = new BoardView(document.getElementById("board"), [
   	    {type: "settlement", element:document.getElementById("settlement-model"), center:{x:15,y:15}},
   	    {type: "city", 		 element:document.getElementById("city-model"), 	  center:{x:25,y:15}},
   	    {type: "robber", 	 element:document.getElementById("robber-model"), 	  center:{x:40,y:30}}
   	]);
	Event.addListener(boardView, "scale", function(w,h) {
		var svg = document.getElementById("svg");
		svg.setAttribute("width", 1.1*w + "px");
		svg.setAttribute("height", 1.1*h + "px");
	});
	boardView.setBoard(board);
	
	var dash = new DashboardView($("#pp"), {% ifequal color None %} false {% else %} true {% endifequal %} );
	dash.setBoard(board);
	dash.setBoardView(boardView);
	

	layout.addItem($("#toolbar"), "top", 30);

	var chatview = new ChatView($("#chat"));
	chatview.setBoard(board);
	
	var tradeView = new TradeView($("#trade-inner"));
	tradeView.setBoard(board);
	
	Event.addListener(tradeView, "changeoffer", function(offer) {
		var offerDict = new Object();
		for(var i = 0; offer && i < offer.length; i++) {
			var o = offer[i];
			offerDict[o.resource] = o.amount;
		}
		console.log("offerDict: " + offerDict);
		console.log("json(offerDict): " + JSON.stringify(offerDict));
		board.sendAction("changeTradeOffer", offerDict);
	});
	Event.addListener(tradeView, "changebankoffer", function(offer) {
		var offerDict = new Object();
		for(var i = 0; offer && i < offer.length; i++) {
			var o = offer[i];
			offerDict[o.resource] = o.amount;
		}
		console.log("offerDict: " + offerDict);
		console.log("json(offerDict): " + JSON.stringify(offerDict));
		board.sendAction("changeBankOffer", offerDict); 
	});

	Event.addListener(tradeView, "acceptoffer", function(colorTo) {
		board.sendAction("acceptTradeOffer", colorTo);
	});

	Event.addListener(tradeView, "confirmoffer", function() {
		board.sendAction("confirmTradeOffer", null);
	});
	Event.addListener(tradeView, "confirmbankoffer", function() {
		board.sendAction("confirmBankOffer", null);
	});
		
	layout.addItem($("#trade"), "left", 100, true);	
	    
    layout.addItem($("#pp"), "right", 350, true);
	layout.addItem($("#chat"), "bottom", 200, true, false);
	
    layout.addItem(document.getElementById("game-board"), "center");
	
	board.load();

	/*
    $("#reserveLink").click(function() {
    	var responder = board.reserve( $('#reserveEmail').val());
    	Event.addListener(responder, "reserved", function() {
    		$('#reserveMessage').text("Sent Invitation.");
    		$('#reserveEmail').val("");
    	});
    	Event.addListener(responder, "error", function() {
    		$('#reserveMessage').text("Invitation Failed to Send.");
    	});		
    });  
	*/
}


$(function() {
	//TODO: must transform coordinates before translation or scaling...
	var trans = new Transform2d();	
	
	var mousedown_ = false;
	var pageX_ = 0;
	var pageY_ = 0;
	
	var blockerDiv = null;
	
	var board = document.getElementById("board");

	
	var mousemove = function(e) {
		if(mousedown_) {
			move(e.pageX, e.pageY);	
			
			e.preventDefault();
			e.stopPropagation();	
		}	
	}
	var mouseout = function(e) {
		if(mousedown_) {
			move(e.pageX, e.pageY);
			stopmove();
			
			mousedown_ = false;
		}	
	}
	var mousedown = function(e) {
		if(e.which == 2) {
			mousedown_ = true;
			startmove(e.pageX, e.pageY);
			
			e.preventDefault();
			e.stopPropagation();
		}	
	}
	
	var stopmove = function() {
		if(blockerDiv) {
			blockerDiv.remove();
			blockerDiv = null;
		}
	}
	var startmove = function(pageX, pageY) {		
		//$(".chat-window").append("<p>" + trans.toString() + "</p>");
		pageX_ = pageX;
		pageY_ = pageY;

		blockerDiv = $("<div style='position:absolute;top:0px;left:0px;height:100%;width:100%;'/>");
		$("#game-board").append(blockerDiv);
		
		blockerDiv.mouseup(mouseout);
		blockerDiv.mouseout(mouseout);
		blockerDiv.mousemove(mousemove);
		blockerDiv.mousedown(mousedown);
	}
	var move = function(pageX, pageY) {
		//$(".chat-window").append("<p>px,py " + pageX + "," + pageY + "</p>");
		//$(".chat-window").append("<p>epx,epy " + e.pageX + "," + e.pageY + "</p>");
		
		var x = pageX - pageX_;
		var y = pageY - pageY_;
		

		//var vec = trans.transformFrom([x,y]);
		
		trans.translate(x,y);
		
		board.setAttribute("transform", trans.toSVG());
					
		
		pageX_ = pageX;
		pageY_ = pageY;
	}
	
	var zoom = function(scale, pageX, pageY) {
		var pos = $(board.parentNode.parentNode).position();
		
		var x = pageX - pos.left;
		var y = pageY - pos.top;
					
		
		trans.translate(-x, -y).scale(scale).translate(x,y);
		
		/*
		
		$(".chat-window").append("<p>pos " + pos.left + "," + pos.top + "</p>");
		$(".chat-window").append("<p>e " + e.pageX + "," + e.pageY + "</p>");
		$(".chat-window").append("<p>x,y " + x + "," + y + "</p>");
		$(".chat-window").append("<p>dx,dy " + dx + "," + dy + "</p>");
		$(".chat-window").append("<p>x0,y0 " + vec0[0] + "," + vec0[1] + "</p>");
		
		var vec0 = trans.transformFrom([0,0]);
		var vec1 = trans.transformFrom([x,y]);
		
		var dx = vec1[0] - vec0[0];
		var dy = vec1[1] - vec0[1];
		
		var vec2 = trans.transformFrom([dx, dy]);
		
		trans.translate(vec2[0],vec2[1]);
		*/
		
		board.setAttribute("transform", trans.toSVG());
	}

	var mousewheel = function(e) {
		var delta = 0;
		if(e.detail) {
			delta = -e.detail/3;
		}
		
		if(delta != 0) {
			var scale = Math.pow(1.1, delta);
			
			zoom(scale, e.pageX, e.pageY);
		}
		
		if (e.preventDefault)
	        e.preventDefault();
		e.returnValue = false;
	}
	
	var touchstart = function(e) {
		e.preventDefault();
		if(e.touches.length == 1) {
			startmove(e.touches[0].pageX, e.touches[0].pageY);
		}
	}
	var touchmove = function(e) {
		e.preventDefault();
		if(e.touches.length == 1) {
			move(e.touches[0].pageX, e.touches[0].pageY);
		}
		
	}
	var touchend = function(e) {
		e.preventDefault();
		if(e.touches.length == 1) {
			move(e.touches[0].pageX, e.touches[0].pageY);
			stopmove();
		}
		
	}
	var touchcancel = function(e) {
		
	}
	
	var moztouchstart = function(e) {
		e.preventDefault();
		startmove(e.pageX, e.pageY);
	}
	var moztouchmove = function(e) {
		e.preventDefault();
		move(e.pageX, e.pageY);
	}
	var moztouchend = function(e) {
		e.preventDefault();
		move(e.pageX, e.pageY);
		stopmove();
	}
	
    if(window.addEventListener) 
    	window.addEventListener('DOMMouseScroll', function(e) {mousewheel(e);}, false);
    
    if(document.addEventListener) {
    	document.addEventListener('touchstart', touchstart, false);
    	document.addEventListener('touchmove', touchmove, false);
    	document.addEventListener('touchend', touchend, false);
    	document.addEventListener('touchcancel', touchcancel, false);
    	
    	document.addEventListener('MozTouchDown', moztouchstart, false);
    	document.addEventListener('MozTouchMove', moztouchmove, false);
    	document.addEventListener('MozTouchUp', moztouchend, false);
    }
	    
    window.onmousewheel = mousewheel;
	
    
	$("#game-board").mousedown(mousedown);
	
	
	
})




$(document).ready(handleLoad);

//]]></script>
</head>

<body>

    <div id="toolbar">
        <a href="/">Back to Game List</a>
        
        {% if isOwner %}
        	<!--  <input id="reserveEmail" type="text" /> <a href="javascript:void(0)" id="reserveLink">Reserve</a> <span id="reserveMessage"></span> -->
        {% endif %}
        
        <span id="current-player">
        {% ifequal color None %}
            <a href="{{joinUrl}}"><span>Join Game</span></a>
        {% else %}
        You are: <div class="player-{{ color }}" style="width:10px; height:10px; display:inline-block;"></div> {{ nick }} 
        {% endifequal %}
        </span> 
        
        <span id="errorMessage"></span>
    </div>

    <div id="game-board">
    
		<!--
		<object id="AdobeSVG" classid="clsid:78156a80-c6a1-4bbf-8e6a-3cd390eeb4e2"> </object>
		<?import namespace="svg" urn="http://www.w3.org/2000/svg" implementation="#AdobeSVG"?>
		-->
		
		
		<svg xmlns="http://www.w3.org/2000/svg" version="1.1" baseProfile="full" width="100%" height="100%" id="svg">
			<defs>
		    <marker id="Triangle"
		      viewBox="0 0 10 10" refX="0" refY="5" 
		      markerUnits="strokeWidth"
		      markerWidth="4" markerHeight="3"
		      orient="auto">
		      <path d="M 0 0 L 10 5 L 0 10 z" />
		    </marker>
		  </defs>
		    <g id="board"></g>
		    <g id="prototypes" style="visibility:hidden;">
		        <svg id="settlement-model" y="331.41016151377545" x="635">
		            <g>
		                <rect  width="30" height="30"
		                       style="stroke: black;"/>
		                <line x1="15" y1="0" x2="15" y2="30" style="stroke:black;" />
		            </g>
		
		        </svg>
		        <svg id="city-model" x="325" y="158.20508075688772">
		            <g>
		                <rect  x="0" y="0" width="50" height="30"
		                       style="stroke: black;"/>
		                <line x1="15" y1="0" x2="15" y2="30" style="stroke:black;" />
		                <line x1="30" y1="0" x2="30" y2="30" style="stroke:black;" />
		            </g>
		        </svg>
		        <svg id="robber-model">
		        	<g>
		        		<circle cx="16" cy="16" r="15" style="stroke:black;fill:#444444;" />
		        	</g>
		        </svg>
		    </g>
		    
		   
		
		</svg>
</div> <!-- game-board -->


<div id="pp"></div>

<div id="chat"></div>

<div id="trade">
<h3>Trade</h3>
<div id="trade-inner"></div>
</div>

</body>

</html>
